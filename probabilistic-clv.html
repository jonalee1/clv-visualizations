<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Probabilistic CLV Model Visualization</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .container {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #2c3e50;
    }
    .tabs {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      background-color: #e9ecef;
      border: none;
      transition: background-color 0.3s;
    }
    .tab.active {
      background-color: #4361ee;
      color: white;
    }
    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .control-group {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
    }
    .control-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .control-group p {
      margin: 0 0 10px 0;
      font-size: 0.9em;
      color: #666;
    }
    .stats {
      background-color: #e6f3ff;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }
    .chart-container {
      height: 400px;
      margin-bottom: 20px;
    }
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
      gap: 15px;
    }
    .info-card {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
    }
    .info-card h3 {
      margin-top: 0;
      margin-bottom: 10px;
      color: #2c3e50;
    }
    ul {
      padding-left: 20px;
    }
    .control-value {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Probabilistic CLV Models: Interactive Visualization</h2>
    
    <div class="tabs">
      <button class="tab active" data-view="beta">Beta Distribution</button>
      <button class="tab" data-view="survival">Survival Curves</button>
      <button class="tab" data-view="clv">CLV Projection</button>
    </div>
    
    <div class="controls">
      <div class="control-group">
        <label for="alpha">Alpha (α) = <span id="alphaValue" class="control-value">2.0</span></label>
        <p>Shape parameter for Beta distribution</p>
        <input type="range" id="alpha" min="0.5" max="10" step="0.1" value="2.0">
      </div>
      
      <div class="control-group">
        <label for="beta">Beta (β) = <span id="betaValue" class="control-value">8.0</span></label>
        <p>Shape parameter for Beta distribution</p>
        <input type="range" id="beta" min="0.5" max="20" step="0.1" value="8.0">
      </div>
      
      <div class="control-group" id="churnRateControl" style="display: none;">
        <label for="churnRate">Fixed Churn Rate = <span id="churnRateValue" class="control-value">20</span>%</label>
        <p>For traditional exponential model</p>
        <input type="range" id="churnRate" min="1" max="50" step="1" value="20">
      </div>
      
      <div class="control-group" id="periodsControl" style="display: none;">
        <label for="periods">Time Periods = <span id="periodsValue" class="control-value">24</span></label>
        <p>Number of time periods to model</p>
        <input type="range" id="periods" min="12" max="60" step="12" value="24">
      </div>
      
      <div class="control-group averageValueControl" style="display: none;">
        <label for="averageValue">Average Period Value = $<span id="averageValueValue" class="control-value">50</span></label>
        <p>Revenue per customer per period</p>
        <input type="range" id="averageValue" min="10" max="200" step="5" value="50">
      </div>
      
      <div class="control-group discountRateControl" style="display: none;">
        <label for="discountRate">Discount Rate = <span id="discountRateValue" class="control-value">10</span>%</label>
        <p>Annual discount rate for future value</p>
        <input type="range" id="discountRate" min="0" max="30" step="1" value="10">
      </div>
    </div>
    
    <div class="stats">
      <h3>Key Statistics:</h3>
      <div class="stats-grid">
        <div>
          <p><strong>Mean Churn Probability:</strong> <span id="meanChurn">20.0</span>%</p>
          <p style="font-size: 0.9em; color: #666;">Expected average churn rate</p>
        </div>
        <div>
          <p><strong>Mean Retention Period:</strong> <span id="meanRetention">5.0</span> periods</p>
          <p style="font-size: 0.9em; color: #666;">Expected average customer lifetime</p>
        </div>
        <div id="clvStat" style="display: none;">
          <p><strong>Expected CLV:</strong> $<span id="expectedCLV">0.00</span></p>
          <p style="font-size: 0.9em; color: #666;">Total expected value over time</p>
        </div>
      </div>
    </div>
    
    <div class="chart-container">
      <canvas id="mainChart"></canvas>
    </div>
    
    <div class="info-grid">
      <div class="info-card" id="modelExplanation">
        <h3>Understanding Beta Distribution:</h3>
        <div id="betaExplanation">
          <ul class="list-disc pl-5 space-y-1">
            <li><span class="font-semibold">Shape Parameters:</span> α = 2.0, β = 8.0</li>
            <li><span class="font-semibold">Mean:</span> α/(α+β) = 0.200</li>
            <li><span class="font-semibold">Interpretation:</span> This shows how churn probability is distributed across customers</li>
            <li><span class="font-semibold">Impact:</span> Higher β values create more right-skewed distributions (more low-churn customers)</li>
          </ul>
        </div>
        
        <div id="survivalExplanation" style="display: none;">
          <ul class="list-disc pl-5 space-y-1">
            <li><span class="font-semibold">Fixed Rate Model:</span> All customers have the same 20% churn probability</li>
            <li><span class="font-semibold">Beta-Geometric Model:</span> Customers have heterogeneous churn rates from Beta(α=2.0, β=8.0)</li>
            <li><span class="font-semibold">Key Difference:</span> BG model produces longer-tailed retention curves</li>
            <li><span class="font-semibold">Business Impact:</span> BG model typically projects more accurate long-term retention than fixed-rate</li>
          </ul>
        </div>
        
        <div id="clvExplanation" style="display: none;">
          <ul class="list-disc pl-5 space-y-1">
            <li><span class="font-semibold">Period Value:</span> Expected value in each period (green line)</li>
            <li><span class="font-semibold">Cumulative CLV:</span> Total expected value over time (blue line)</li>
            <li><span class="font-semibold">Discount Rate:</span> Accounts for time value of money (10%)</li>
            <li><span class="font-semibold">Business Use:</span> Helps determine maximum customer acquisition cost (CAC)</li>
          </ul>
        </div>
      </div>
      
      <div class="info-card" id="businessImplications">
        <h3>Business Implications:</h3>
        
        <div id="betaImplications">
          <div class="space-y-2">
            <p><span class="font-semibold">Customer Heterogeneity:</span> While traditional models assume all customers have the same churn probability, the Beta distribution models how this varies across your customer base.</p>
            <p><span class="font-semibold">Marketing Application:</span> This heterogeneity explains why retention curves aren't exponential in real data - some customers are naturally more loyal than others.</p>
            <p><span class="font-semibold">Segmentation Insight:</span> The shape of this distribution helps inform customer segmentation strategies.</p>
          </div>
        </div>
        
        <div id="survivalImplications" style="display: none;">
          <div class="space-y-2">
            <p><span class="font-semibold">Retention Planning:</span> The Beta-Geometric model typically shows higher long-term retention than fixed-rate models.</p>
            <p><span class="font-semibold">Forecasting:</span> More accurate retention forecasting leads to better resource planning and valuation.</p>
            <p><span class="font-semibold">Cohort Analysis:</span> These curves help predict how new customer cohorts will perform over time.</p>
          </div>
        </div>
        
        <div id="clvImplications" style="display: none;">
          <div class="space-y-2">
            <p><span class="font-semibold">Investment Decisions:</span> CLV projections guide customer acquisition spending.</p>
            <p><span class="font-semibold">Retention Value:</span> Shows the financial impact of improving retention rates.</p>
            <p><span class="font-semibold">Customer Prioritization:</span> Helps identify which customers deserve more attention and investment.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Helper functions
    function betaPDF(x, alpha, beta) {
      // Beta function approximation
      function betaFn(a, b) {
        return Math.exp(logGamma(a) + logGamma(b) - logGamma(a + b));
      }
      
      // Log gamma function using Stirling's approximation
      function logGamma(z) {
        if (z < 0.5) {
          return Math.log(Math.PI) - Math.log(Math.sin(Math.PI * z)) - logGamma(1 - z);
        }
        // Stirling's approximation
        let result = (z - 0.5) * Math.log(z + 4.5) - (z + 4.5);
        result += Math.log(Math.sqrt(2 * Math.PI));
        result += 0.918938533204673 / (z + 0.5); // Correction term
        return result;
      }
      
      if (x <= 0 || x >= 1) return 0;
      
      const logBeta = logGamma(alpha) + logGamma(beta) - logGamma(alpha + beta);
      const logPdf = (alpha - 1) * Math.log(x) + (beta - 1) * Math.log(1 - x) - logBeta;
      
      return Math.exp(logPdf);
    }

    // Generate geometric survival curve
    function generateGeometricSurvival(p, periods) {
      const data = [];
      const labels = [];
      let survival = 1;
      
      for (let t = 0; t <= periods; t++) {
        data.push(survival);
        labels.push(t);
        survival *= (1 - p);
      }
      return { data, labels };
    }

    // Generate BG survival curve with beta heterogeneity
    function generateBGSurvival(alpha, beta, periods) {
      const data = [];
      const labels = [];
      
      for (let t = 0; t <= periods; t++) {
        // BG survival formula: S(t) = beta / (beta + t * alpha)
        const survival = beta / (beta + t * alpha);
        data.push(survival);
        labels.push(t);
      }
      return { data, labels };
    }

    // Generate beta distributed churn probabilities
    function generateBetaDistribution(alpha, beta) {
      const data = [];
      const labels = [];
      
      for (let i = 0; i <= 100; i++) {
        const x = i / 100;
        const density = betaPDF(x, alpha, beta);
        data.push(density);
        labels.push(x.toFixed(2));
      }
      return { data, labels };
    }

    // Generate expected CLV over time
    function generateExpectedCLV(alpha, beta, averageValue, discountRate, periods) {
      const survivalData = generateBGSurvival(alpha, beta, periods);
      const periodValues = [];
      const cumulativeValues = [];
      const labels = [];
      
      let cumulativeCLV = 0;
      for (let t = 0; t <= periods; t++) {
        const survivalProb = survivalData.data[t];
        const discountFactor = 1 / Math.pow(1 + discountRate/100, t);
        const periodValue = averageValue * survivalProb * discountFactor;
        cumulativeCLV += periodValue;
        
        periodValues.push(periodValue);
        cumulativeValues.push(cumulativeCLV);
        labels.push(t);
      }
      
      return { periodValues, cumulativeValues, labels };
    }

    // Chart and UI setup
    let mainChart = null;
    let currentView = 'beta';
    
    // Parameters
    let alpha = 2.0;
    let beta = 8.0;
    let churnRate = 20; // in percent
    let periods = 24;
    let averageValue = 50;
    let discountRate = 10;
    
    // Initialize chart
    function initChart() {
      const ctx = document.getElementById('mainChart').getContext('2d');
      mainChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Beta PDF',
            data: [],
            borderColor: 'rgba(136, 132, 216, 1)',
            backgroundColor: 'rgba(136, 132, 216, 0.3)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: {
                display: true,
                text: 'Churn Probability'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Probability Density'
              }
            }
          }
        }
      });
    }
    
    // Update chart based on current view and parameters
    function updateChart() {
      if (!mainChart) return;
      
      // Calculate statistics
      const betaMean = alpha / (alpha + beta);
      const meanRetention = 1 / betaMean;
      
      // Update statistics display
      document.getElementById('meanChurn').textContent = (betaMean * 100).toFixed(1);
      document.getElementById('meanRetention').textContent = meanRetention.toFixed(1);
      
      // Update explanations
      updateExplanationText();
      
      // Update chart based on current view
      switch(currentView) {
        case 'beta':
          const betaData = generateBetaDistribution(alpha, beta);
          mainChart.data.labels = betaData.labels;
          mainChart.data.datasets = [{
            label: 'Beta PDF',
            data: betaData.data,
            borderColor: 'rgba(136, 132, 216, 1)',
            backgroundColor: 'rgba(136, 132, 216, 0.3)',
            fill: true,
            tension: 0.4
          }];
          mainChart.options.scales.x.title.text = 'Churn Probability';
          mainChart.options.scales.y.title.text = 'Probability Density';
          break;
          
        case 'survival':
          const geoSurvival = generateGeometricSurvival(churnRate/100, periods);
          const bgSurvival = generateBGSurvival(alpha, beta, periods);
          
          mainChart.data.labels = bgSurvival.labels;
          mainChart.data.datasets = [
            {
              label: 'Fixed Churn Rate',
              data: geoSurvival.data,
              borderColor: 'rgba(255, 115, 0, 1)',
              backgroundColor: 'transparent',
              fill: false,
              tension: 0
            },
            {
              label: 'Beta-Geometric',
              data: bgSurvival.data,
              borderColor: 'rgba(136, 132, 216, 1)',
              backgroundColor: 'transparent',
              fill: false,
              tension: 0
            }
          ];
          mainChart.options.scales.x.title.text = 'Time Period';
          mainChart.options.scales.y.title.text = 'Survival Probability';
          break;
          
        case 'clv':
          const clvData = generateExpectedCLV(alpha, beta, averageValue, discountRate, periods);
          
          mainChart.data.labels = clvData.labels;
          mainChart.data.datasets = [
            {
              label: 'Period Value',
              data: clvData.periodValues,
              borderColor: 'rgba(130, 202, 157, 1)',
              backgroundColor: 'transparent',
              fill: false,
              tension: 0,
              yAxisID: 'y'
            },
            {
              label: 'Cumulative CLV',
              data: clvData.cumulativeValues,
              borderColor: 'rgba(136, 132, 216, 1)',
              backgroundColor: 'transparent',
              fill: false,
              tension: 0,
              yAxisID: 'y1'
            }
          ];
          mainChart.options.scales = {
            x: {
              title: {
                display: true,
                text: 'Time Period'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Period Value ($)'
              },
              type: 'linear',
              position: 'left'
            },
            y1: {
              title: {
                display: true,
                text: 'Cumulative CLV ($)'
              },
              type: 'linear',
              position: 'right',
              grid: {
                drawOnChartArea: false
              }
            }
          };
          
          // Update CLV statistic
          document.getElementById('expectedCLV').textContent = clvData.cumulativeValues[clvData.cumulativeValues.length - 1].toFixed(2);
          document.getElementById('clvStat').style.display = 'block';
          break;
      }
      
      mainChart.update();
    }
    
    // Handle parameter changes
    function setupEventListeners() {
      // Tab switching
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          // Update active tab
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          // Update current view
          currentView = tab.dataset.view;
          
          // Show/hide controls based on view
          document.getElementById('churnRateControl').style.display = 
            currentView === 'survival' ? 'block' : 'none';
          document.getElementById('periodsControl').style.display = 
            currentView !== 'beta' ? 'block' : 'none';
          
          // Show/hide CLV-specific controls
          const clvControls = document.querySelectorAll('.averageValueControl, .discountRateControl');
          clvControls.forEach(control => {
            control.style.display = currentView === 'clv' ? 'block' : 'none';
          });
          
          // Update explanation text
          updateExplanationText();
          
          // Update chart
          updateChart();
        });
      });
      
      // Parameter sliders
      document.getElementById('alpha').addEventListener('input', (e) => {
        alpha = parseFloat(e.target.value);
        document.getElementById('alphaValue').textContent = alpha.toFixed(1);
        updateChart();
      });
      
      document.getElementById('beta').addEventListener('input', (e) => {
        beta = parseFloat(e.target.value);
        document.getElementById('betaValue').textContent = beta.toFixed(1);
        updateChart();
      });
      
      document.getElementById('churnRate').addEventListener('input', (e) => {
        churnRate = parseInt(e.target.value);
        document.getElementById('churnRateValue').textContent = churnRate;
        updateChart();
      });
      
      document.getElementById('periods').addEventListener('input', (e) => {
        periods = parseInt(e.target.value);
        document.getElementById('periodsValue').textContent = periods;
        updateChart();
      });
      
      document.getElementById('averageValue').addEventListener('input', (e) => {
        averageValue = parseInt(e.target.value);
        document.getElementById('averageValueValue').textContent = averageValue;
        updateChart();
      });
      
      document.getElementById('discountRate').addEventListener('input', (e) => {
        discountRate = parseInt(e.target.value);
        document.getElementById('discountRateValue').textContent = discountRate;
        updateChart();
      });
    }
    
    // Update explanation text based on current view
    function updateExplanationText() {
      // Show/hide appropriate explanation sections
      document.getElementById('betaExplanation').style.display = currentView === 'beta' ? 'block' : 'none';
      document.getElementById('survivalExplanation').style.display = currentView === 'survival' ? 'block' : 'none';
      document.getElementById('clvExplanation').style.display = currentView === 'clv' ? 'block' : 'none';
      
      document.getElementById('betaImplications').style.display = currentView === 'beta' ? 'block' : 'none';
      document.getElementById('survivalImplications').style.display = currentView === 'survival' ? 'block' : 'none';
      document.getElementById('clvImplications').style.display = currentView === 'clv' ? 'block' : 'none';
      
      // Update beta explanation
      if (currentView === 'beta') {
        const betaMean = alpha / (alpha + beta);
        document.getElementById('betaExplanation').innerHTML = `
          <ul class="list-disc pl-5 space-y-1">
            <li><span class="font-semibold">Shape Parameters:</span> α = ${alpha.toFixed(1)}, β = ${beta.toFixed(1)}</li>
            <li><span class="font-semibold">Mean:</span> α/(α+β) = ${betaMean.toFixed(3)}</li>
            <li><span class="font-semibold">Interpretation:</span> This shows how churn probability is distributed across customers</li>
            <li><span class="font-semibold">Impact:</span> Higher β values create more right-skewed distributions (more low-churn customers)</li>
          </ul>
        `;
      }
      
      // Update survival explanation
      if (currentView === 'survival') {
        document.getElementById('survivalExplanation').innerHTML = `
          <ul class="list-disc pl-5 space-y-1">
            <li><span class="font-semibold">Fixed Rate Model:</span> All customers have the same ${churnRate}% churn probability</li>
            <li><span class="font-semibold">Beta-Geometric Model:</span> Customers have heterogeneous churn rates from Beta(α=${alpha.toFixed(1)}, β=${beta.toFixed(1)})</li>
            <li><span class="font-semibold">Key Difference:</span> BG model produces longer-tailed retention curves</li>
            <li><span class="font-semibold">Business Impact:</span> BG model typically projects more accurate long-term retention than fixed-rate</li>
          </ul>
        `;
      }
      
      // Update CLV explanation
      if (currentView === 'clv') {
        document.getElementById('clvExplanation').innerHTML = `
          <ul class="list-disc pl-5 space-y-1">
            <li><span class="font-semibold">Period Value:</span> Expected value in each period (green line)</li>
            <li><span class="font-semibold">Cumulative CLV:</span> Total expected value over time (blue line)</li>
            <li><span class="font-semibold">Discount Rate:</span> Accounts for time value of money (${discountRate}%)</li>
            <li><span class="font-semibold">Business Use:</span> Helps determine maximum customer acquisition cost (CAC)</li>
          </ul>
        `;
      }
    }
    
    // Initialize the application
    function init() {
      initChart();
      setupEventListeners();
      updateChart();
    }
    
    // Start the app when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>